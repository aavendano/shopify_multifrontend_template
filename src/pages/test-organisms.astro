---
import ProductGrid from '../molecules/ProductGrid.astro';
import ProductCard from '../molecules/ProductCard.astro';
import FiltersPanel from '../organisms/FiltersPanel.astro';
import Header from '../organisms/Header.astro';
import Footer from '../organisms/Footer.astro';
import ProductGallery from '../organisms/ProductGallery.astro';
import ProductDetails from '../organisms/ProductDetails.astro';
import CartDrawer from '../organisms/CartDrawer.astro';
import RelatedProducts from '../organisms/RelatedProducts.astro';

import {
    products,
    filters,
    navItems,
    footerLinks,
    productDetails,
    cartItems,
    galleryImages,
    copyright
} from '../mocks/testData';

import '../styles/main.scss';
---

<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Organisms Test</title>
</head>
<body class="has-navbar-fixed-top">
    <Header logo="MyStore" navItems={navItems} cartCount={2} showCartBadge={true} />

    <div class="section">
        <div class="container">
            <h2 class="title is-4">ProductDetails</h2>
            <ProductDetails
                product={productDetails}
                currentPrice={productDetails.variants[0].price}
                currentStock={productDetails.variants[0].stock}
                variantOptions={productDetails.variants.map(v => ({ label: v.title, value: v.id }))}
                selectedVariantId={productDetails.variants[0].id}
            />
        </div>
    </div>

    <div class="section">
        <div class="container">
            <h2 class="title is-4">ProductGallery</h2>
            <div class="is-inline-block">
                <ProductGallery
                    images={galleryImages}
                    currentImage={galleryImages[0]}
                />
            </div>
        </div>
    </div>

    <div class="section">
        <div class="container">
            <h2 class="title is-4">ProductGrid & Card</h2>
            <ProductGrid columns={4}>
                <div class="columns is-multiline">
                  {products.map((product) => (
                    <div class="column is-one-quarter-desktop is-half-tablet is-full-mobile">
                      <ProductCard
                        productId={product.id}
                        title={product.title}
                        image={product.image}
                        price={product.price}
                        compareAtPrice={product.compareAtPrice}
                        badgeText={product.badgeText}
                        href={product.href}
                        quantity={product.stock}
                        showQuickAdd={true}
                      />
                    </div>
                  ))}
                </div>
            </ProductGrid>
        </div>
    </div>

    <div class="section">
        <div class="container">
            <h2 class="title is-4">FiltersPanel</h2>
            <div class="columns">
                <div class="column is-one-quarter">
                    <FiltersPanel filters={filters} selectedFilters={{}} />
                </div>
                <div class="column">
                    <p>Filter results here...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="container">
            <h2 class="title is-4">CartDrawer (Click Cart Icon in Header to Open)</h2>
            <CartDrawer isOpen={false} items={cartItems} formattedSubtotal="$199.98" />
        </div>
    </div>

    <RelatedProducts>
      <div class="columns is-multiline">
        {products.slice(0, 3).map((product) => (
          <div class="column is-one-third">
            <ProductCard
              productId={product.id}
              title={product.title}
              image={product.image}
              price={product.price}
              compareAtPrice={product.compareAtPrice}
              badgeText={product.badgeText}
              href={product.href}
              quantity={product.stock}
            />
          </div>
        ))}
      </div>
    </RelatedProducts>

    <div id="event-log" style="position: fixed; bottom: 0; right: 0; background: rgba(0,0,0,0.8); color: white; padding: 10px; max-height: 200px; overflow: auto; z-index: 1000; width: 300px;">
        Logs will appear here...
    </div>

    <Footer links={footerLinks} copyright={copyright} />

    <script>
        const logEl = document.getElementById('event-log');
        const log = (msg: string) => {
            if (logEl) {
                const div = document.createElement('div');
                div.textContent = msg;
                logEl.prepend(div);
            }
            if (import.meta.env.DEV) {
                console.log(msg);
            }
        };

        // Event logging
        document.body.addEventListener('add-to-cart', (e) => log(`Event: add-to-cart ${JSON.stringify((e as CustomEvent).detail)}`));
        document.body.addEventListener('variant-change', (e) => log(`Event: variant-change ${JSON.stringify((e as CustomEvent).detail)}`));

        document.body.addEventListener('filter-change', (e) => {
            const detail = (e as CustomEvent).detail;
            if (detail && detail.formData instanceof FormData) {
                const data: Record<string, any> = {};
                detail.formData.forEach((value, key) => {
                    if (data[key]) {
                        if (!Array.isArray(data[key])) {
                            data[key] = [data[key]];
                        }
                        data[key].push(value);
                    } else {
                        data[key] = value;
                    }
                });
                log(`Event: filter-change ${JSON.stringify({ ...detail, formData: data })}`);
            } else {
                log(`Event: filter-change ${JSON.stringify(detail)}`);
            }
        });

        document.body.addEventListener('image-change', (e) => log(`Event: image-change ${JSON.stringify((e as CustomEvent).detail)}`));
        document.body.addEventListener('menu-toggle', () => log('Event: menu-toggle'));

        document.body.addEventListener('cart-open', () => {
            log('Event: cart-open');
            const drawer = document.querySelector('.cart-drawer-overlay');
            if (drawer) drawer.classList.add('is-active');
        });

        document.body.addEventListener('close', () => {
            log('Event: close (cart)');
            const drawer = document.querySelector('.cart-drawer-overlay');
            if (drawer) drawer.classList.remove('is-active');
        });

        document.body.addEventListener('remove-item', (e) => log(`Event: remove-item ${JSON.stringify((e as CustomEvent).detail)}`));
        document.body.addEventListener('checkout', () => log('Event: checkout'));
    </script>
</body>
</html>
