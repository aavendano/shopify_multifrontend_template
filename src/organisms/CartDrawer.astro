---
import TextBlock from '../atoms/TextBlock.astro';
import Button from '../atoms/Button.astro';
import Image from '../atoms/Image.astro';
import Icon from '../atoms/Icon.astro';

interface CartItem {
  id: string;
  productId: string;
  title: string;
  variantTitle?: string;
  image: string;
  formattedPrice: string;
  quantity: number;
}

interface Props {
  isOpen: boolean;
  items: CartItem[];
  formattedSubtotal: string;
}

const { isOpen, items, formattedSubtotal } = Astro.props;
---

<div class={`modal cart-drawer-overlay ${isOpen ? 'is-active' : ''}`}>
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <TextBlock tag="h2" size="4" weight="bold">Your Cart</TextBlock>
      <Button variant="ghost" class="close-btn" aria-label="Close cart">
        <Icon name="close" size="medium" />
      </Button>
    </header>

    <section class="modal-card-body">
      {items.length === 0 ? (
        <TextBlock tag="p" class="has-text-centered has-text-grey py-6">
          Your cart is empty.
        </TextBlock>
      ) : (
        items.map((item) => (
          <div class="cart-item is-flex mb-4 pb-4">
            <div class="mr-3 is-flex-shrink-0 is-96x96">
              <Image src={item.image} alt={item.title} ratio="square" class="rounded" />
            </div>
            <div class="cart-item-details is-flex-grow-1">
              <div class="is-flex is-justify-content-space-between mb-1">
                <TextBlock tag="h3" size="6" weight="bold">{item.title}</TextBlock>
                <Button
                  variant="ghost"
                  size="small"
                  class="remove-item-btn p-0 has-text-danger"
                  data-id={item.id}
                  aria-label="Remove item"
                >
                  <Icon name="close" size="small" />
                </Button>
              </div>
              {item.variantTitle && (
                <TextBlock tag="p" size="7" color="grey" class="mb-1">{item.variantTitle}</TextBlock>
              )}
              <div class="is-flex is-justify-content-space-between is-align-items-center mt-2">
                <TextBlock tag="span" size="7">Qty: {item.quantity}</TextBlock>
                <TextBlock tag="span" weight="bold">
                  {item.formattedPrice}
                </TextBlock>
              </div>
            </div>
          </div>
        ))
      )}
    </section>

    <footer class="modal-card-foot is-flex is-justify-content-space-between is-align-items-center">
      <div>
        <TextBlock tag="span" weight="bold">Subtotal</TextBlock>
        <TextBlock tag="span" weight="bold" size="4" class="ml-2">
          {formattedSubtotal}
        </TextBlock>
      </div>
      <Button
        variant="primary"
        size="large"
        class="checkout-btn"
        disabled={items.length === 0}
      >
        Checkout
      </Button>
    </footer>
  </div>
</div>

<script>
  const overlay = document.querySelector('.cart-drawer-overlay');

  if (overlay) {
    overlay.addEventListener('click', (e) => {
      if ((e.target as HTMLElement).classList.contains('modal-background')) {
        overlay.dispatchEvent(new CustomEvent('close', {
          bubbles: true,
          detail: {}
        }));
      }
    });

    const closeBtn = overlay.querySelector('.close-btn');
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        overlay.dispatchEvent(new CustomEvent('close', {
          bubbles: true,
          detail: {}
        }));
      });
    }

    overlay.querySelectorAll('.remove-item-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        overlay.dispatchEvent(new CustomEvent('remove-item', {
          detail: { id },
          bubbles: true
        }));
      });
    });

    const checkoutBtn = overlay.querySelector('.checkout-btn');
    if (checkoutBtn) {
      checkoutBtn.addEventListener('click', () => {
        overlay.dispatchEvent(new CustomEvent('checkout', {
          bubbles: true,
          detail: {}
        }));
      });
    }
  }
</script>
