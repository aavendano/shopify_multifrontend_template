---
import TextBlock from '../atoms/TextBlock.astro';
import ProductPrice from '../molecules/ProductPrice.astro';
import ProductStockIndicator from '../molecules/ProductStockIndicator.astro';
import VariantSelector from '../molecules/VariantSelector.astro';
import QuantitySelector from '../molecules/QuantitySelector.astro';
import Button from '../atoms/Button.astro';

interface Product {
  id: string;
  title: string;
  description: string;
  currency?: string;
}

interface VariantOption {
  label: string;
  value: string;
}

interface Props {
  product: Product;
  selectedVariantId?: string;
  currentPrice: number | string;
  currentComparePrice?: number | string;
  currentStock: number;
  variantOptions: VariantOption[];
  quantity?: number;
}

const {
  product,
  selectedVariantId,
  currentPrice,
  currentComparePrice,
  currentStock,
  variantOptions,
  quantity = 1
} = Astro.props;
---

<div class="product-details box p-5">
  <TextBlock tag="h1" size="2" weight="bold" class="mb-4">{product.title}</TextBlock>

  <div class="mb-5">
    <ProductPrice
      price={currentPrice}
      compareAtPrice={currentComparePrice}
      currency={product.currency}
      showSavings={true}
    />
  </div>

  <div class="mb-5">
    <ProductStockIndicator quantity={currentStock} />
  </div>

  <div class="mb-6">
    <TextBlock tag="p" class="content">{product.description}</TextBlock>
  </div>

  <form class="product-form" data-product-id={product.id}>
    <div class="mb-5">
      <VariantSelector
        options={variantOptions}
        selected={selectedVariantId}
        name="Variant"
      />
    </div>

    <div class="mb-5">
      <QuantitySelector
        value={quantity}
        max={currentStock}
      />
    </div>

    <Button
      variant="primary"
      size="large"
      fullWidth={true}
      class="add-to-cart-btn"
      disabled={currentStock === 0}
    >
      {currentStock === 0 ? 'Out of Stock' : 'Add to Cart'}
    </Button>
  </form>
</div>

<script>
  document.querySelectorAll('.product-form').forEach(form => {
    form.addEventListener('variant-change', (e) => {
      e.stopPropagation();
      const detail = (e as CustomEvent).detail;
      const productId = form.getAttribute('data-product-id');

      form.dispatchEvent(new CustomEvent('variant-change', {
        detail: { ...detail, productId },
        bubbles: true
      }));
    });

    form.addEventListener('quantity-change', (e) => {
      e.stopPropagation();
      const detail = (e as CustomEvent).detail;
      const productId = form.getAttribute('data-product-id');

      form.dispatchEvent(new CustomEvent('quantity-change', {
        detail: { ...detail, productId },
        bubbles: true
      }));
    });

    const addBtn = form.querySelector('.add-to-cart-btn');
    if (addBtn) {
      addBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const productId = form.getAttribute('data-product-id');

        form.dispatchEvent(new CustomEvent('add-to-cart', {
          bubbles: true,
          detail: {
            productId
          }
        }));
      });
    }
  });
</script>
