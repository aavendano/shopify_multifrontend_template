---
import CardMedia from './CardMedia.astro';
import CardContent from './CardContent.astro';
import Button from '../atoms/Button.astro';

/**
 * Product Card Component
 *
 * Displays a summary of a product including image, title, price, and an optional "Quick Add" button.
 * It is composed of `CardMedia` and `CardContent` molecules.
 *
 * @event add-to-cart - Dispatched when the "Quick Add" button is clicked.
 * Detail: `{ productId: string }`
 */
interface Props {
  /** The unique identifier for the product. */
  productId: string;
  /** The product title. */
  title: string;
  /** The URL of the product image. */
  image: string;
  /** The current price. */
  price: number | string;
  /** The original price (if on sale). */
  compareAtPrice?: number | string;
  /** The currency code. */
  currency?: string;
  /** Text for an overlay badge (e.g., "New"). */
  badgeText?: string;
  /** The URL to the product detail page. */
  href: string;
  /** The current stock quantity. */
  quantity?: number;
  /** The threshold for low stock warning. */
  lowStockThreshold?: number;
  /** Whether to show the "Add to Cart" button. @default false */
  showQuickAdd?: boolean;
}

const {
  productId,
  title,
  image,
  price,
  compareAtPrice,
  currency,
  badgeText,
  href,
  quantity,
  lowStockThreshold,
  showQuickAdd = false,
} = Astro.props;
---

<div class="product-card card is-hoverable has-shadow is-flex is-flex-direction-column" data-product-id={productId}>
  <a href={href} class="is-block">
    <CardMedia
      src={image}
      alt={title}
      badgeText={badgeText}
      aspectRatio="square"
    />
  </a>

  <div class="p-4 is-flex is-flex-direction-column is-justify-content-space-between is-flex-grow-1">
    <a href={href} class="has-text-black">
      <CardContent
        title={title}
        price={price}
        compareAtPrice={compareAtPrice}
        currency={currency}
        quantity={quantity}
        lowStockThreshold={lowStockThreshold}
      />
    </a>

    {showQuickAdd && (
      <div class="mt-4">
        <Button
          variant="primary"
          fullWidth={true}
          class="quick-add-btn"
        >
          Add to Cart
        </Button>
      </div>
    )}
  </div>
</div>

<script>
  document.querySelectorAll('.product-card').forEach(card => {
    const btn = card.querySelector('.quick-add-btn');
    if (btn) {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const productId = card.getAttribute('data-product-id');

        card.dispatchEvent(new CustomEvent('add-to-cart', {
          detail: { productId },
          bubbles: true
        }));
      });
    }
  });
</script>
